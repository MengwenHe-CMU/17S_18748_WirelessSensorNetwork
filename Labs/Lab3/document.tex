\documentclass[letterpaper,10pt]{article}
\usepackage[margin=1.5cm]{geometry}

\usepackage{color}
\usepackage[colorlinks=true]{hyperref}
\usepackage{graphicx}

\title{\textbf{Lab3 Protocol}}
\author{Emily Ruppel, Iljoo Baek, Mengwen He}

\begin{document}

\maketitle
\tableofcontents
\newpage

\section{Self-Organization}

\begin{figure}[!h]
	\centering
	\includegraphics[width=12cm]{./img/selforganization.png}
\end{figure}

\subsection{Gateway}

\subsubsection{TX (G-Thread-1): Message ID 0x00}

\begin{enumerate}
	\item Start (re-)organization at time $t$ (default reorganization interval: 5s configurable)
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		%\item Clear children list $\{CID_i$\}
		\item Clear parent-child list $\{<PID,CID>_i\}$
		\item Increase round count $\rho\leftarrow(\rho+1)\%256$
	\end{enumerate}	
	\item \colorbox{green}{Mutex unlock}
	\item Broadcast an organization message with $\rho$, and node ID $NID$:\\
	\framebox[0.6\textwidth]{Message ID 0x00 [1B], $\rho$ [1B], $NID$ [1B]: e.g. 0x00 0x04 0x00}
	\item \colorbox{yellow}{goto 1}
\end{enumerate}

\subsubsection{RX (G-Thread-2): Message ID 0x01}

\begin{enumerate}
	\item Get and parse the replied organization message (Message ID 0x01)
	\begin{itemize}
		\item received round count $\rho_R$
		\item received parent ID $PID_R$
		\item received parent-child pair $<PID,CID>_R$	
	\end{itemize}
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		\item If $\rho_R \neq \rho$ or $PID_R \neq NID$, then \colorbox{green}{mutex unlock} and \colorbox{yellow}{goto 1}
		%\item If $PID_R = <PID,CID>_R::PID$, then add $<PID,CID>_R::CID$ to $\{CID_i\}$
		\item Add $<PID,CID>_R$ to $\{<PID,CID>_i\}$ and refresh the neighbor list of $<PID,CID>_R::PID$ node.
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
	\item \colorbox{yellow}{goto 1}	
\end{enumerate}

\subsection{Communication Node}

\subsubsection{RX (N-Thread-1): Message ID 0x00}

\begin{enumerate}
	\item Get and parse the organization message (Message ID 0x00):
	\begin{itemize}
		\item received round count $\rho_R$
		\item received note ID $NID_R$
		\item RSSI level $\Phi$
	\end{itemize}
	\item If $\Phi<\Phi^*$ ($\Phi^*$ is the minimum required RSSI to build a reliable wireless connection), then \colorbox{yellow}{goto 1}
	\item If its own round count $\rho=\rho_R$, then \colorbox{yellow}{goto 1}
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		%\item Clear children list $\{CID_i\}$
		\item Set round count: $\rho=\rho_R$
		\item Set parent ID: $PID=NID_R$
		\item Reply an acknowledge message with $\rho$, $PID$, and $NID$:\\
		\framebox[0.8\textwidth]{Message ID 0x01 [1B], $\rho$ [1B], $PID$ [1B], $<PID,NID>$ [2B]: e.g. 0x01 0x04 0x01 0x01 0x02}
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
	\item Broadcast an organization message with $\rho$, and $NID$:\\
	\framebox[0.6\textwidth]{Message ID 0x00 [1B], $\rho$ [1B], $NID$ [1B]: e.g. 0x00 0x04 0x01}
	\item \colorbox{yellow}{goto 1}
\end{enumerate}

\subsubsection{RX (N-Thread-1): Message ID 0x01}

\begin{enumerate}
	\item Get and parse the replied organization message (Message ID 0x01)
	\begin{itemize}
		\item received round count $\rho_R$
		\item received parent ID $PID_R$
		\item received parent-child pair $<PID,CID>_R$
	\end{itemize}
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		\item If $\rho_R \neq \rho$ or $PID_R \neq NID$, then \colorbox{green}{mutex unlock} and \colorbox{yellow}{goto 1}
		%\item If $PID_R = <PID,CID>_R::PID$, then add $<PID,CID>_R::CID$ to $\{CID_i\}$
		\item Relay an acknowledge message with $\rho$, $PID$, and  $<PID,CID>_R$:\\
		\framebox[0.8\textwidth]{Message ID 0x01 [1B], $\rho$ [1B], $PID$ [1B], $<PID,CID>_R$ [2B]: e.g. 0x01 0x04 0x00 0x01 0x02}
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
	\item \colorbox{yellow}{goto 1}	
\end{enumerate}


\newpage
\section{Upload Light Values}

\begin{figure}[!h]
	\centering
	\includegraphics[width=12cm]{./img/lightvalue.png}
\end{figure}

\subsection{Gateway}

\subsubsection{RX (G-Thread-2): Message ID 0x02}

\begin{enumerate}
	\item Get and parse the light value message (Message ID 0x02)
	\begin{itemize}
		\item received round count $\rho_R$
		\item received parent ID $PID_R$
		\item received node ID $NID_R$
		\item received light value $L_R$
	\end{itemize}
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		\item If $\rho_R \neq \rho$ or $PID_R \neq NID$, then \colorbox{green}{Mutex unlock} and \colorbox{yellow}{goto 1}
		\item Display light value ``$NID_R$'s light value is $L_R$"
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
	\item \colorbox{yellow}{goto 1}
\end{enumerate}

\subsection{Communication Node}

\subsubsection{RX (N-Thread-1): Message ID 0x02}

\begin{enumerate}
	\item Get and parse the light value message (Message ID 0x02)
	\begin{itemize}
		\item received round count $\rho_R$
		\item received parent ID $PID_R$
		\item received node ID $NID_R$
		\item received light value $L_R$
	\end{itemize}
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		\item If $\rho_R \neq \rho$ or $PID_R \neq NID$, then \colorbox{green}{Mutex unlock} and \colorbox{yellow}{goto 1}
		\item Relay light value message with $\rho$, $PID$, $NID_R$, and $L_R$ to parent:\\
		\framebox[0.85\textwidth]{Message ID 0x02 [1B], $\rho$[1B], $PID$ [1B], $NID_R$ [1B], $L_R$ [2B]: e.g. 0x02 0x04 0x00 0x02 0x11 0x23}
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
	\item \colorbox{yellow}{goto 1}
\end{enumerate}

\subsubsection{TX (N-Thread-2): Message ID 0x02}

\begin{enumerate}
	\item Sample start at time $t$ (sample rate is controlled by $dt$ ms and is configurable via gateway)
	\item Get light value $L_t$
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		\item Send light value message with $\rho$, $PID$, $NID$, and $L_t$ to parent:\\
		\framebox[0.85\textwidth]{Message ID 0x02 [1B], $\rho$[1B], $PID$ [1B], $NID$ [1B], $L_t$ [2B]: e.g. 0x02 0x04 0x01 0x02 0x11 0x23}
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
	\item \colorbox{yellow}{goto 1}
\end{enumerate}

\newpage
\section{Configure Sample Rate}

\begin{figure}[!h]
	\centering
	\includegraphics[width=12cm]{./img/samplerate.png}
\end{figure}

\subsection{Gateway}

\subsubsection{TX2 (G-Thread-3): Message ID 0x03}

\begin{enumerate}
	\item Give a new sample rate $dt$
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		\item Broadcast a sample rate message with $\rho$, $NID$, and $dt$ (ms):\\
		\framebox[0.85\textwidth]{Message ID 0x03 [1B], $\rho$[1B], $NID$ [1B], $dt$ [4B]: e.g. 0x03 0x04 0x00 0x19 0x90 0x11 0x23}
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
\end{enumerate}

\subsubsection{RX (G-Thread-2): Message ID 0x04}

\begin{enumerate}
	\item Get and parse the sample rate update message (Message ID 0x04)
	\begin{itemize}
		\item received round count $\rho_R$
		\item received parent ID $PID_R$
		\item received node ID $NID_R$
		\item received sample rate $dt_R$
	\end{itemize}
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		\item If $\rho_R \neq \rho$ or $PID_R \neq NID$, then \colorbox{green}{Mutex unlock} and \colorbox{yellow}{goto 1}
		\item Display sample rate update info ``$NID_R$'s sample rate changes to $dt_R$"
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
	\item \colorbox{yellow}{goto 1}
\end{enumerate}

\subsection{Communication Node}

\subsubsection{RX (N-Thread-1): Message ID 0x03}

\begin{enumerate}
	\item Get and parse the sample rate message (Message ID 0x03)
	\begin{itemize}
		\item received round count $\rho_R$
		\item received parent ID $PID_R$
		\item received sample rate $dt_R$
	\end{itemize}
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		\item If $\rho_R \neq \rho$ or $PID_R \neq PID$, then \colorbox{green}{Mutex unlock} and \colorbox{yellow}{goto 1}
		\item Set $dt=dt_R$
		\item Reply a sample rate update message with $\rho$, $PID$, $NID$, and $dt$ (ms):\\
		\framebox[0.9\textwidth]{Message ID 0x04 [1B], $\rho$[1B], $PID$ [1B], $NID$ [1B], $dt$ [4B]: e.g. 0x03 0x04 0x01 0x02 0x19 0x90 0x11 0x23}
		\item Relay a sample rate message with $\rho$, $NID$, and $dt$ (ms):\\
		\framebox[0.85\textwidth]{Message ID 0x03 [1B], $\rho$[1B], $NID$ [1B], $dt$ [4B]: e.g. 0x03 0x04 0x01 0x19 0x90 0x11 0x23}
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
	\item \colorbox{yellow}{goto 1}
\end{enumerate}

\subsubsection{RX (N-Thread-1): Message ID 0x04}

\begin{enumerate}
	\item Get and parse the sample rate update message (Message ID 0x04)
	\begin{itemize}
		\item received round count $\rho_R$
		\item received parent ID $PID_R$
		\item received node ID $NID_R$
		\item received light value $dt_R$
	\end{itemize}
	\item \colorbox{red}{Mutex lock}
	\begin{enumerate}
		\item If $\rho_R \neq \rho$ or $PID_R \neq NID$, then \colorbox{green}{Mutex unlock} and \colorbox{yellow}{goto 1}
		\item Relay sample rate update message with $\rho$, $PID$, $NID_R$, and $dt_R$ to parent:\\
		\framebox[0.92\textwidth]{Message ID 0x04 [1B], $\rho$[1B], $PID$ [1B], $NID_R$ [1B], $dt_R$ [4B]: e.g. 0x03 0x04 0x00 0x02 0x19 0x90 0x11 0x23}
	\end{enumerate}
	\item \colorbox{green}{Mutex unlock}
	\item \colorbox{yellow}{goto 1}
\end{enumerate}

\end{document}